<!DOCTYPE html>
<html>
<head>
  <title>RoadTripper Viewport</title>
  <style>
    html, body, #pano {
      height: 100%;
      margin: 0;
      padding: 0;
      cursor: none !important;
    }
    * {
      cursor: none !important;
    }
  </style>
</head>
<body>
  <div id="pano"></div>
  <script>
    let panorama;
    let streetViewService;

    function initPanorama(lat, lng, heading, panoId, preferNewest) {
      // Initialize Street View Service if not already done
      if (!streetViewService) {
        streetViewService = new google.maps.StreetViewService();
      }
      const options = {
        pov: { heading: heading || 0, pitch: 0 },
        visible: true,
        disableDefaultUI: true,
        addressControl: false,
        linksControl: false,
        panControl: false,
        enableCloseButton: false,
        fullscreenControl: false,
        motionTracking: false,
        motionTrackingControl: false,
        zoomControl: false,
        showRoadLabels: false,
        clickToGo: false,
        scrollwheel: false,
        imageDateControl: false
      };

      // Prefer outdoor (official Google) imagery over user-contributed content
      if (preferNewest) {
        options.source = google.maps.StreetViewSource.OUTDOOR;
      }

      if (panoId && !preferNewest) {
        // Only use specific pano ID if not preferring newest
        options.pano = panoId;
      } else {
        options.position = { lat, lng };
      }

      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("pano"),
        options
      );

      // Listen for status changes and errors
      panorama.addListener('status_changed', () => {
        const status = panorama.getStatus();
        if (status !== 'OK') {
          console.error(`Panorama status: ${status}`);
        }
      });

      return !!panorama;
    }

    function getLinks() {
      return panorama.getLinks();
    }

    function moveToPano(panoId, heading) {
      panorama.setPano(panoId);
      if (heading !== undefined) {
        panorama.setPov({ heading: heading, pitch: 0 });
      }
    }

    function getPosition() {
      const pos = panorama.getPosition();
      if (!pos) return null;

      let imageDate = null;
      try {
        if (typeof panorama.getImageDate === 'function') {
          const date = panorama.getImageDate();
          imageDate = date ? date.toISOString() : null;
        }
      } catch (e) {
        console.warn('Could not get image date:', e.message);
      }

      return {
        lat: pos.lat(),
        lng: pos.lng(),
        heading: panorama.getPov().heading,
        pano: panorama.getPano(),
        imageDate: imageDate
      };
    }

    async function getPanoMetadata(panoId) {
      return new Promise((resolve) => {
        streetViewService.getPanorama({pano: panoId}, (data, status) => {
          if (status === 'OK' && data) {
            const imageDate = data.imageDate ? new Date(data.imageDate).toISOString() : null;
            resolve({
              imageDate: imageDate,
              location: data.location,
              links: data.links
            });
          } else {
            resolve(null);
          }
        });
      });
    }

    async function getPositionWithMetadata() {
      const pos = panorama.getPosition();
      if (!pos) return null;

      const panoId = panorama.getPano();

      // Try to get date from panorama first
      let imageDate = null;
      try {
        if (typeof panorama.getImageDate === 'function') {
          const date = panorama.getImageDate();
          imageDate = date ? date.toISOString() : null;
        }
      } catch (e) {
        console.warn('Could not get image date from panorama:', e.message);
      }

      // If no date from panorama, try metadata service
      if (!imageDate && panoId) {
        try {
          const metadata = await getPanoMetadata(panoId);
          if (metadata && metadata.imageDate) {
            imageDate = metadata.imageDate;
          }
        } catch (e) {
          console.warn('Could not get metadata:', e.message);
        }
      }

      return {
        lat: pos.lat(),
        lng: pos.lng(),
        heading: panorama.getPov().heading,
        pano: panoId,
        imageDate: imageDate
      };
    }

    function getImageDate() {
      try {
        if (typeof panorama.getImageDate === 'function') {
          const date = panorama.getImageDate();
          return date ? date.toISOString() : null;
        }
      } catch (e) {
        console.warn('Could not get image date:', e.message);
      }
      return null;
    }
  </script>
</body>
</html>
