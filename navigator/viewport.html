<!DOCTYPE html>
<html>
<head>
  <title>RoadTripper Viewport</title>
  <style>
    html, body, #pano {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .gmnoprint, .gm-style-cc {
      display: none;
    }
  </style>
</head>
<body>
  <div id="pano"></div>
  <script>
    let panorama;
    let streetViewService;

    function updateTitle(title) {
      document.title = title;
    }

    function initPanoramaV(lat, lng, heading, pano) {
      if (!streetViewService) {
        streetViewService = new google.maps.StreetViewService();
      }
      const options = {
        pov: { heading: heading || 0, pitch: 0 },
        visible: true,
        disableDefaultUI: true,
        addressControl: false,
        linksControl: false,
        panControl: false,
        enableCloseButton: false,
        fullscreenControl: false,
        motionTracking: false,
        motionTrackingControl: false,
        zoomControl: false,
        showRoadLabels: false,
        clickToGo: false,
        scrollwheel: false,
        imageDateControl: false
      };

      options.source = google.maps.StreetViewSource.GOOGLE;

      if (pano) {
        // Always prioritize the specific pano ID if provided (for resuming state)
        options.pano = pano;
      } else {
        options.position = { lat, lng };
      }

      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("pano"),
        options
      );

      // Listen for status changes and errors
      panorama.addListener('status_changed', () => {
        const status = panorama.getStatus();
        if (status !== 'OK') {
          console.error(`Panorama status: ${status}`);
        }
      });

      return !!panorama;
    }

    function moveToPanoV(pano, heading) {
      panorama.setPano(pano);
      if (heading !== undefined) {
        panorama.setPov({ heading: heading, pitch: 0 });
      }
    }
    /* Get the position data from whatever position the current panorama is in */
    function getCurrentPositionPanoV() {
      const pos = panorama.getPosition();
      if (!pos) {
        return null;
      }

      return {
        pano: panorama.getPano(),
        heading: panorama.getPov().heading
      };
    }

    /* get position data for an arbitrary panoId */
    async function getPanoDataV(pano) {
      if (!streetViewService) { return false; }
      return new Promise((resolve) => {
        streetViewService.getPanorama({ pano: pano }, async (data, status) => {
          if (status === 'OK' && data) {
            const date = data.imageDate ? new Date(data.imageDate).toISOString().slice(0, 7) : null;
            // standardize the variable name for times.date (it can be GA/HA/zA etc.)
            const times = data.time ? data.time.map(item => {
              const dynamicKey = Object.keys(item).find(key => key !== 'pano');
              return {
                pano: item.pano,
                date: item[dynamicKey].toISOString().slice(0, 7)
              };
            }) : null;
            let result = {
              date: date,
              lat: data.location.latLng.lat(),
              lng: data.location.latLng.lng(),
              description: data.location.shortDescription,
              pano: pano,
              links: data.links,
              times: times
            };
            resolve(result);
          } else {
            resolve(null);
          }
        });
      });
    }
  </script>
</body>
</html>
